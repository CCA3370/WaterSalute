# WaterSalute - X-Plane 12 Water Salute Plugin

X-Plane 12 插件，模拟飞机过水门仪式。两辆消防车驶向飞机并喷射水柱形成水拱门。

## 功能

- 通过菜单控制启动/停止
- 自动检查飞机在地面且速度 < 40 节
- 消防车根据飞机翼展自动定位
- 8x8 消防车物理转向模型

## 安装

将 `WaterSalute` 文件夹复制到 `X-Plane 12/Resources/plugins/`

## 使用

1. 飞机在地面低速滑行
2. 菜单：**Plugins → Water Salute → Start Water Salute**
3. 点击 **Stop** 结束仪式

## Datarefs

所有 dataref 为 float 数组，索引 0 = 左侧消防车，索引 1 = 右侧消防车。

**镜像同步**：设置任意一辆车的参数时，另一辆车会自动同步：
- **速度、车轮旋转角度、水炮角度**：两车完全相同
- **转向角度**：两车镜像（符号相反），实现对称运动

因此只需控制一辆车（索引 0 或 1）的参数，另一辆车会自动镜像同步。

| Dataref | 单位 | 范围 | 读写 | 说明 |
|---------|------|------|------|------|
| `watersalute/truck/front_steering_angle` | 度 | -45 ~ 45 | R/W | 前轮转向角（镜像同步） |
| `watersalute/truck/rear_steering_angle` | 度 | -45 ~ 45 | R/W | 后轮转向角（镜像同步） |
| `watersalute/truck/wheel_rotation_angle` | 度 | 0 ~ 360 | R | 车轮旋转角度（根据车速实时计算） |
| `watersalute/truck/cannon_pitch` | 度 | 0 ~ 90 | R/W | 水炮俯仰角（同步） |
| `watersalute/truck/cannon_yaw` | 度 | -180 ~ 180 | R/W | 水炮偏航角（同步） |
| `watersalute/truck/speed` | m/s | - | R | 车辆速度 |

## 转向系统

### 阿克曼转向模型（Ackermann Steering）

本插件使用阿克曼转向几何模型计算8x8消防车的转向速率。该模型适用于具有前后轮转向能力的车辆，能够提供更真实的转向行为。

#### 核心公式

转弯半径和转向速率的计算公式如下：

```
转弯半径 R = wheelbase / (tan(δ_f) + tan(|δ_r|))
转向速率 ω = speed / R = speed × (tan(δ_f) + tan(|δ_r|)) / wheelbase
```

其中：
- `δ_f` - 前轮转向角（度）
- `δ_r` - 后轮转向角（度）
- `wheelbase` - 轴距（6米）
- `speed` - 车辆速度（m/s）

#### 转向参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 最大转向角 | ±45° | 前后轮最大转向角度 |
| 轴距 | 6.0 m | 前后轴之间的距离 |
| 车轮半径 | 0.5 m | 用于计算车轮旋转角度 |
| 后轮转向比 | 0.4 | 后轮角度 = -前轮角度 × 0.4 |

#### 转向逻辑

1. **前轮转向角**（`front_steering_angle`）为主控制输入：
   - 范围：±45度
   - 正值：右转
   - 负值：左转

2. **后轮反向转向**（Counter-steering）：
   - 后轮角度自动计算：`δ_r = -δ_f × 0.4`
   - 后轮与前轮反向转动，减小转弯半径
   - 提高车辆在狭窄空间的机动性

3. **转向速率计算**（使用阿克曼方法）：
   - 综合前后轮转向角计算等效转向速率
   - 公式：`ω = speed × (tan(δ_f) + tan(|δ_r|)) / wheelbase`
   - 实现中由于后轮角度为负值（反向转向），代码使用 `tan(δ_f) - tan(δ_r)` 来获得相同效果

4. **航向更新**：
   - 车辆航向根据转向速率实时更新
   - `heading += ω × dt`

#### 简化说明

本模型为简化的阿克曼模型，**不区分内外轮的不同角度和速度**。在真实的阿克曼转向几何中，内轮和外轮需要不同的转向角度以避免轮胎侧滑，但本插件将所有轮子视为具有相同的转向角度，以简化计算并满足模拟需求。

## 车辆物理参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 接近速度 | 15 m/s | 消防车接近飞机的速度 |
| 原地转向速度 | 2 m/s | 用于计算原地转向时的转向速率 |
| 离开速度倍数 | 0.667 | 离开时速度 = 接近速度 × 2/3 |
| 加速度 | 3 m/s² | 消防车加速时的加速度 |
| 减速度 | 4 m/s² | 消防车减速时的减速度 |
| 停止距离 | 200 m | 消防车在飞机前方停止的距离 |
| 额外间距 | 40 m | 消防车间距 = 翼展/2 + 20m |

### 离开行为

当用户点击 Stop 停止水门仪式时，消防车会：
1. 首先转向（左侧车向左转45°，右侧车向右转45°）
2. 完成转向后以接近速度的2/3速度驶离
3. 驶离600米后消失

## License

GPLv3 详见 LICENSE 文件